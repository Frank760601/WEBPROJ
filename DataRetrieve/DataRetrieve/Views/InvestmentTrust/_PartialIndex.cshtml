@model dynamic
@using System.ComponentModel.DataAnnotations;
@using PagedList.Core.Mvc;
@inject IEmployee _emp
@{
}
<html lang="en">
<body>
    <div class="row">
        <div class="col-md-8">
            @try
            {
            <!-- BEGIN EXAMPLE TABLE PORTLET-->
            @if (Model.TRUST.TotalItemCount > 0)
            {
                <div class="portlet-body" style="border:1px solid #D7D6D5" id="TRUST">

                    <div id="sample_1_wrapper" class="dataTables_wrapper no-footer">
                        <div class="table-scrollable" style="margin-top:0px!important">
                            <table class="table table-striped table-bordered table-hover  order-column dataTable no-footer" id="sample_1" role="grid" aria-describedby="sample_1_info">
                                <thead>
                                    <tr role="row" style="background-color:#84B167;color:white;font-family:'微軟正黑體'">
                                        <th class="sorting_asc center" tabindex="0" aria-controls="sample_1" rowspan="1" colspan="1" aria-sort="ascending" aria-label=" Username : activate to sort column descending" style="width: 273px;"></th>
                                        @{
                                            var TRUSTCnt = ((List<string>)Model.TRUSTHEAD).Count();
                                            for (int i = 0; i < TRUSTCnt - 1; i++)
                                            {
                                                <th class="sorting_asc center" tabindex="0" aria-controls="sample_1" rowspan="1" colspan="1" aria-sort="ascending" aria-label=" Username : activate to sort column descending" style="width: 273px;">@Model.TRUSTHEAD[i]</th>
                                            }
                                        }
                                    </tr>
                                </thead>
                                <tbody>
                                    @{

                                        @foreach (var Item in Model.TRUST)
                                        {
                                            @:<tr class="gradeX odd" role="row">
                                                var row = (Item as IDictionary<string, object>).Values.ToList();
                                                  <td class="center" nowrap="nowrap" style="text-align:center">
                                                      <a href="javascript:;" class="btn btn-outline btn-circle green btn-sm purple btnEdit"><i class="fa fa-edit"></i> 修改</a>
                                                      <a href="javascript:;" class="btn btn-outline btn-circle green btn-sm purple btnSave" style="display:none"><i class="fa fa-edit"></i> 儲存</a>
                                                      <a href="javascript:;" class="btn btn-outline btn-circle dark btn-sm black btnDelete"><i class="fa fa-calendar-minus-o"></i> 刪除</a>
                                                  </td>
                                                @for (int i = 0; i < row.Count() - 1; i++)
                                                {
                                                    var value = row[i];
                                                    if (new Type[] { typeof(int), typeof(float), typeof(double), typeof(decimal) }.Contains(value.GetType()))
                                                    {
                                                        <td class="center" nowrap="nowrap" style="text-align:right">
                                                            <span class="Show">@(Decimal.ToInt32(Decimal.Parse(value.ToString())) == 0 ? 0 : Decimal.ToInt32(Decimal.Parse(value.ToString())))</span>
                                                            <input type="text" class="form-control Edit" style="display:none" value="@(Decimal.ToInt32(Decimal.Parse(value.ToString())) == 0 ? 0 : Decimal.ToInt32(Decimal.Parse(value.ToString())))">
                                                        </td>
                                                    }
                                                    else
                                                    {
                                                        <td class="center" nowrap="nowrap" style="text-align:center">
                                                            <span class="Show">@value</span>
                                                            <input type="text" class="form-control Edit" style="display:none" value="@value">
                                                        </td>
                                                    }
                                                }
                                            @:</tr>
                                        }

                                    }
                                </tbody>
                            </table>
                        </div>
                        <div class="row">
                            <div class="col-md-7 col-sm-7" id="pagination" style="padding-right:0%!important">
                                <pager class="dataTables_paginate paging_bootstrap_number"
                                       list="@(PagedList.Core.IPagedList)Model.TRUST"
                                       options='@new PagedListRenderOptions {
                                                                        DisplayLinkToIndividualPages = false,
                                                                        DisplayLinkToFirstPage = PagedListDisplayMode.Always,
                                                                        DisplayLinkToLastPage = PagedListDisplayMode.Always,
                                                                        DisplayLinkToPreviousPage = PagedListDisplayMode.Always,
                                                                        DisplayLinkToNextPage = PagedListDisplayMode.Always,
                                                                        DisplayPageCountAndCurrentLocation = true,
                                                                        PageCountAndCurrentLocationFormat = "第 {0} 頁/共 {1} 頁"
                                                                }' />
                            </div>
                            <div class="col-md-5 col-sm-5" id="PaginationInfo" style="height:55px;line-height:55px">
                                <div class="dataTables_info" id="sample_1_info" role="status" aria-live="polite">
                                    顯示 @((Model.TRUST.PageNumber - 1) * 10 + 1) - @(((Model.TRUST.PageNumber - 1) * 10) + Model.TRUST.Count) 共 @Model.TRUST.TotalItemCount 筆
                                </div>
                            </div>
                        </div>

                    </div>
                </div>
            }
            else
            {
                <div class="note note-success" style="color:#337AB7;vertical-align:middle!important;text-align:center;height:100px;font-size:25px;font-family:'微軟正黑體';line-height:75px;font-weight:600">
                    無符合查詢條件之資料
                </div>
            }
             }
            catch (Exception ex) {
            ex.ToString();
            }
            <!-- END EXAMPLE TABLE PORTLET-->
        </div>
    </div>
</body>
</html>
<style type="text/css">
    .table-scrollable div {
        margin-left: 2px;
        margin-right: 2px;
    }

    .ui-button-text {
        outline: none;
    }

    .ui-widget-header {
        border: 1px solid #aaaaaa;
        background: #337ab7 50% 50% repeat-x;
        color: white;
        font-weight: bold;
    }

    #tree3, #tree3 ul {
        margin: 0;
        padding: 0;
        list-style: none
    }

        #tree3 ul {
            margin-left: 1em;
            position: relative
        }

            #tree3 ul ul {
                margin-left: .5em
            }

            #tree3 ul:before {
                content: "";
                display: block;
                width: 0;
                position: absolute;
                top: 0;
                bottom: 0;
                left: 0;
                border-left: 1px solid
            }

        #tree3 li {
            margin: 0;
            padding: 0 1em;
            line-height: 2em;
            color: #369;
            font-weight: 700;
            position: relative
        }

        #tree3 ul li:before {
            content: "";
            display: block;
            width: 10px;
            height: 0;
            border-top: 1px solid;
            margin-top: -1px;
            position: absolute;
            top: 1em;
            left: 0
        }

        #tree3 ul li:last-child:before {
            background: #fff;
            height: auto;
            top: 1em;
            bottom: 0
        }

    .indicator {
        margin-right: 5px;
    }

    #tree3 li a {
        text-decoration: none;
        color: #369;
    }

    #tree3 li button, #tree3 li button:active, #tree3 li button:focus {
        text-decoration: none;
        color: #369;
        border: none;
        background: transparent;
        margin: 0px 0px 0px 0px;
        padding: 0px 0px 0px 0px;
        outline: 0;
    }

    .note {
        border-right: 5px solid #58d0da !important
    }

    #myProgress {
        width: 100px;
        background-color: #ddd;
    }

    #myBar {
        width: 0%;
        height: 15px;
        background-color: #337AB7;
        text-align: center;
        line-height: 15px;
        color: white;
        font-size: 10px
    }

    .center {
        text-align: center;
        vertical-align: middle;
    }
</style>
<script src="~/js/jquery.animateNumber.js"></script>
<script>
    var EditING = false;
    $(function () {
        $(".dataTables_paginate").find("ul").addClass("pagination");
        var obj = $(".pagination").find("a");
        $(obj).click(function (event) {
            event.preventDefault();
            var href = $(this).attr("href").substr($(this).attr("href").indexOf("?") + 1)

            var page = href.substr(href.indexOf("=") + 1);
            $("[name=page]").val(page)
            $("[type=submit]").click()
        });
        $(".btnEdit").click(function () {
            if (!EditING) {
                $(this).closest("tr").find(".Edit:eq(1),.Edit:eq(2)").show();
                $(this).closest("tr").find(".Show:eq(1),.Show:eq(2)").hide();
                $(this).closest("tr").find(".btnSave").show();
                $(this).hide();
                EditING = true;
            } else { 
                alert("無法編輯")
            }
        })
        $(".btnSave").click(function () {
            var NO = $(this).closest("tr").find(".Edit:eq(0)").val()
            var NAME = $(this).closest("tr").find(".Edit:eq(1)").val()
            var IDNO = $(this).closest("tr").find(".Edit:eq(2)").val()
            
            var obj = $(this)
            var strCheck = CheckField(obj)
            if (strCheck) {
                swal({
                    title:'欄位檢核',
                    type: 'info',
                    html: strCheck
                })
            } else {
                swal({
                    title: "確定修改？",
                    type: "question",
                    showCancelButton: true//顯示取消按鈕
                }).then(
                    function (result) {
                        if (result.value) {
                            //使用者按下「確定」要做的事

                            $.ajax({
                                type: 'POST',
                                url: '@Url.Action("Update","InvestmentTrust")',
                                data: { NO: NO, NAME: NAME, IDNO: IDNO }, //發送參數
                                success: function (data) {
                                    $("[name=txbSearch]").click();
                                    EditING = false;
                                    //console.log(data.MsgCode.toString().toUpperCase())
                                    swal("群益投信客戶", "修改" + data.MsgName + "！", data.MsgCode.toString().toUpperCase() == "TRUE" ? "success" : "error");
                                },
                                error: function (xhr, ajaxOptions, thrownError) {
                                    alert(xhr.responseText)
                                }
                            });
                        } else {
                            $(obj).closest("tr").find(".Edit:eq(1)").val($(obj).closest("tr").find(".Show:eq(1)").html())
                            $(obj).closest("tr").find(".Edit:eq(2)").val($(obj).closest("tr").find(".Show:eq(2)").html())
                            $(obj).closest("tr").find(".Edit:eq(1),.Edit:eq(2)").hide();
                            $(obj).closest("tr").find(".Show:eq(1),.Show:eq(2)").show();
                            $(obj).closest("tr").find(".btnEdit").show();
                            $(obj).hide();
                            EditING = false;
                        }
                    });//end then 
            }
        })
        $(".btnDelete").click(function () { 
            var NO = $(this).closest("tr").find(".Edit:eq(0)").val()

            swal({
                title: "確定刪除？",
                type: "question",
                showCancelButton: true//顯示取消按鈕
            }).then(
                function (result) {
                    if (result.value) {
                        //使用者按下「確定」要做的事
                        
                        $.ajax({
                            type: 'POST',
                            url: '@Url.Action("Delete","InvestmentTrust")',
                            data: { NO: NO }, //發送參數
                            success: function (data) {
                                $("[name=page]").val(1)
                                $("[name=txbSearch]").submit();
                                swal("群益投信客戶", "刪除" + data.MsgName + "！", "success");
                            },
                            error: function (xhr, ajaxOptions, thrownError) {
                                alert(xhr.responseText)
                            }
                        });
                    } 
            });//end then 
        })
    })
    function CheckField(obj) {
        strCheck = "";
        var Name = $(obj).closest("tr").find(".Edit:eq(1)").val();
        var IDNO = $(obj).closest("tr").find(".Edit:eq(2)").val()
        if (!Name) {
            strCheck += "[客戶名稱]為必填<br/>";
        } else if (Name.length > 50) {
            strCheck += "[客戶名稱]不可超過50個字元<br/>";
        }
        if (!IDNO) {
            strCheck += "[身份證字號或營利事業統一編號]為必填<br/>";
        } else if (IDNO.length > 10) {
            strCheck += "[身份證字號或營利事業統一編號]不可超過10個字元<br/>";
        }
        return strCheck;
    }
</script>
